

<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="LinuxJedi's Technical Blog">
        <meta name="viewport" content="width=device-width">
        <title>libAttachSQL Benchmarks With Sysbench &mdash; LinuxJedi&#39;s /dev/null</title>
            <link rel="stylesheet" href="../../../_static/normalize.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/sphinx.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/main.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/minimal5.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="../../../_static/font-awesome.min.css" type="text/css">
        <link rel="shortcut icon" href="../../../_static/favicon.ico" /><!-- Load modernizr and JQuery -->
        <script src="../../../_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="../../../_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="../../../_static/plugins.js"></script>
        <script src="../../../_static/main.js"></script>
        <link rel="next" title="libAttachSQL Query Example" href="../../09/23/libattachsql_query_example.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.4.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="../../../_static/underscore.js"></script><script type="text/javascript" src="../../../_static/doctools.js"></script><script type="text/javascript" src="../../../_static/disqus.js"></script><script type="text/javascript" src="../../../_static/google_analytics.js"></script></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container">
  <nav role="navigation">
    <ul><li class="quicklink"><div class="rss">
        <a href="../../../rss.html" title="Subscribe via RSS"><span class="fa fa-lg fa-rss"></span></a>
    </div></li><li class="main-nav">
          <a href="../../../index.html">Home</a>
        </li>
      <li class="main-nav">
          <a href="../../../pages/about_me.html">About LinuxJedi</a>
        </li>
      </ul>
  </nav>
  <header role="banner">
    <hgroup>
    <h1><a href="../../../index.html"><img src="../../../_static/LinuxJedi_head.png" alt="LinuxJedi&#39;s /dev/null" /></a></h1><h2>The /dev/null ramblings of a Linux Jedi</h2></hgroup>
  </header><div class="main-container" role="main"><div class="main wrapper clearfix"><article role="article"><ul class="related clearfix">
            <li class="left"></li>
            <li class="right"><a href="../../09/23/libattachsql_query_example.html">libAttachSQL Query Example</a> &raquo; </li>
        </ul><div class="timestamp postmeta">
            <span>October 03, 2014</span>
        </div>
    <div class="section" id="libattachsql-benchmarks-with-sysbench">
<h1>libAttachSQL Benchmarks With Sysbench</h1>
<p>This week I have been spending a little bit of time creating a module for <a class="reference external" href="https://launchpad.net/sysbench">Sysbench</a> so that it can use <a class="reference external" href="http://libattachsql.org/">libAttachSQL</a> as a database driver.  The reason for doing this is twofold:</p>
<ol class="arabic simple">
<li><a class="reference external" href="http://krow.net/">Brian</a> (my boss at HP&#8217;s Advanced Technology Group) said now would be a good time to benchmark libAttachSQL</li>
<li>I really needed more than a few basic queries to shake out bugs in the library, and a benchmark is a good way to shove a few million through it</li>
</ol>
<p>On the bug front, it did find a total of 5 bugs, a couple of them serious.  Which is great, the more testing and bug finding the better.  These have all been fixed in <a class="reference external" href="http://github.com/libattachsql/libattachsql">GitHub</a> and will be part of the upcoming 0.5.0 release.</p>
<div class="section" id="the-test-setup">
<h2>The Test Setup</h2>
<p>To benchmark I used an HP Z620, 6-core Xeon with 16GB RAM and an SSD.  The OS was Antergos Linux (Arch with a nicer theme) and the server was MySQL 5.6.20 compiled from source.  The only real tweaks I&#8217;ve made to the out-of-box config that would make any difference are:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">innodb_buffer_pool_size</span><span class="o">=</span><span class="s">3G</span>
<span class="na">innodb_locks_unsafe_for_binlog</span><span class="o">=</span><span class="s">1</span>
<span class="na">innodb_buffer_pool_instances</span><span class="o">=</span><span class="s">8</span>
<span class="na">thread_cache</span><span class="o">=</span><span class="s">256</span>
<span class="na">query_cache_type</span><span class="o">=</span><span class="s">0</span>
<span class="na">query_cache_size</span><span class="o">=</span><span class="s">0</span>
<span class="na">max_connections</span><span class="o">=</span><span class="s">20020</span>
<span class="na">max_user_connections</span><span class="o">=</span><span class="s">20000</span>
</pre></div>
</div>
<p>The <a class="reference external" href="https://github.com/libattachsql/sysbench">Sysbench in libAttachSQL&#8217;s GitHub</a> was used which just has the additional driver for libAttachSQL.  Once I&#8217;m 100% happy with the driver I offer it as an upstream branch.  libAttachSQL master is used, partly due to the bug fixes and partly because there has been a large API change in master for improved error handling.</p>
<p>For both libmysqlclient and libAttachSQL the connections were made using Unix Domain Sockets.  For the sysbench setup I just left it at the default number of rows.  The Sysbench driver for libAttachSQL enables the semi-blocking mode which is better performance for single-connection-per-thread applications.</p>
</div>
<div class="section" id="select-test">
<h2>Select Test</h2>
<p>First the basic select test was run, which queries for random single integers in a table.  This was run with the MySQL driver as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre>sysbench --test<span class="o">=</span>sysbench/tests/db/select.lua --db-driver<span class="o">=</span>mysql --mysql-socket<span class="o">=</span>/tmp/mysql.sock --mysql-user<span class="o">=</span><span class="nb">test</span> --mysql-password<span class="o">=</span><span class="nb">test</span> --mysql-db<span class="o">=</span>testdb --num-threads<span class="o">=</span>8 --max-requests<span class="o">=</span>1000000 run
</pre></div>
</div>
<p>And libAttachSQL:</p>
<div class="highlight-bash"><div class="highlight"><pre>sysbench --test<span class="o">=</span>sysbench/tests/db/select.lua --db-driver<span class="o">=</span>attachsql --attachsql-socket<span class="o">=</span>/tmp/mysql.sock --attachsql-user<span class="o">=</span><span class="nb">test</span> --attachsql-password<span class="o">=</span><span class="nb">test</span> --attachsql-db<span class="o">=</span>testdb --num-threads<span class="o">=</span>8 --max-requests<span class="o">=</span>1000000 run
</pre></div>
</div>
<p>The results were as follows:</p>
<img alt="../../../_images/select_benchmark.png" src="../../../_images/select_benchmark.png" />
<p>I am pretty impressed with these results so far, since I have done no optimisation work on the code.  I originally wanted the first GA to have performance on-par with libmysqlclient and it looks like that goal has been met.</p>
</div>
<div class="section" id="select-random-points">
<h2>Select Random Points</h2>
<p>I used the &#8220;Select Random Points&#8221; benchmark because it is one of the only ones that comes with Sysbench which uses Prepared Statements.  It selects 10 random integers from a table per query.</p>
<p>As before this was run on using libmysqlclient with:</p>
<div class="highlight-bash"><div class="highlight"><pre>sysbench --test<span class="o">=</span>sysbench/tests/db/select_random_points.lua --db-driver<span class="o">=</span>mysql --mysql-socket<span class="o">=</span>/tmp/mysql.sock --mysql-user<span class="o">=</span><span class="nb">test</span> --mysql-password<span class="o">=</span><span class="nb">test</span> --mysql-db<span class="o">=</span>testdb --num-threads<span class="o">=</span>8 --max-requests<span class="o">=</span>1000000 run
</pre></div>
</div>
<p>And with libAttachSQL:</p>
<div class="highlight-bash"><div class="highlight"><pre>sysbench --test<span class="o">=</span>sysbench/tests/db/select_random_points.lua --db-driver<span class="o">=</span>attachsql --attachsql-socket<span class="o">=</span>/tmp/mysql.sock --attachsql-user<span class="o">=</span><span class="nb">test</span> --attachsql-password<span class="o">=</span><span class="nb">test</span> --attachsql-db<span class="o">=</span>testdb --num-threads<span class="o">=</span>8 --max-requests<span class="o">=</span>1000000 run
</pre></div>
</div>
<p>The results were as follows:</p>
<img alt="../../../_images/select_random_points_benchmark.png" src="../../../_images/select_random_points_benchmark.png" />
<p>Again there isn&#8217;t a lot in it.  libmysqlclient is edging slightly over libAttachSQL in most of this chart.  I believe it is because in the libAttachSQL driver I told it to convert all results to string outputs.  This will add additional overhead.  Next week I will tweak the driver to make sure that the conversion isn&#8217;t done.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>I&#8217;m very happy with these Sysbench tests because not only has it bashed libAttachSQL with a sledgehammer it has given me some idea of the performance.  I&#8217;m happy enough with these figures to not do any performance tuning until after the first GA release.</p>
<p>At some point soon I will also benchmark the single-threaded multi-connection performance of libAttachSQL.  This is not something I can easily compare to libmysqlclient (there is an API to do it, but it is an unofficial/unsupported API).  But it will be a good test for the use case I originally designed the library for.</p>
<p>I am no benchmarking expert and I know many of you who reading this are (especially Percona).  Is there anything I missed or could have done better?  Please let me know in the comments.</p>
</div>
</div>

    <div class="postmeta">
        <div class="author">
            <span>Posted by Andrew (LinuxJedi) Hutchings</span>
        </div>
        <div class="categories">
            <span>
                Filed under:
                <a href="../../../categories/mysql.html">MySQL</a>, <a href="../../../categories/libattachsql.html">libAttachSQL</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="../../../tags/mysql.html">MySQL</a>, <a href="../../../tags/libattachsql.html">libAttachSQL</a>, <a href="../../../tags/hp.html">HP</a>, <a href="../../../tags/advanced_technology_group.html">Advanced Technology Group</a></span>
        </div>
        </div>
    <div id="disqus_thread"></div><script type="text/javascript">    var disqus_shortname = "linuxjedi";    var disqus_identifier = "2014/10/03/libattachsql_benchmarks_with_sysbench";    disqus_thread();</script><noscript>Please enable JavaScript to view the    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><ul class="related clearfix">
            <li class="left"></li>
            <li class="right"><a href="../../09/23/libattachsql_query_example.html">libAttachSQL Query Example</a> &raquo; </li>
        </ul></article><aside class="sidebar"><section><div class="widget" id="conference" role="conference">
<h1>Percona Live London</h1>
<a href="http://www.percona.com/live/london-2014/"><img width="123" height="123" title="Percona Live London, November 3-4, 2014" alt="Percona Live London, November 3-4, 2014" src="http://s0.percona.com/percona-live/pluk14/123x123_UKSpeaking_14.png" /></a>
</div></section>
     <hr /><section><div class="widget" id="book" role="book">
<h1>MySQL 5.1 Plugins Development</h1>
<a href="https://www.packtpub.com/mysql-5-1-plugins-development/book"><img border="0" style="float:left" src="../../../_static/0608OS_MockupCover_sm.png" />
MySQL 5.1 Plugins Development</a> by Andrew Hutchings and Sergei Golubchik is now available from Packt Publishing.
<br style="clear:left;" />
</div></section>
     <hr /><section><div class="widget">
    <h1>Recent Posts</h1>
    <ul><li>
            <a href="#">libAttachSQL Benchmarks With Sysbench</a>
        </li><li>
            <a href="../../09/23/libattachsql_query_example.html">libAttachSQL Query Example</a>
        </li><li>
            <a href="../../09/23/new_blog.html">New Blog!</a>
        </li></ul>
</div>
</section>
     <hr /><section><div class="widget" id="searchbox" role="search">
    <h1>Search</h1>
    <form action="../../../search.html" method="get">
        <input type="text" name="q" />
        <button type="submit"><span class="fa fa-search"></span></button>
    </form>
</div></section>
     <hr /><section><div class="widget">
    <h1>Tags Cloud</h1>
      <a href="../../../tags/advanced_technology_group.html" style="font-size: 20pt">Advanced Technology Group</a>&nbsp;&nbsp;
      <a href="../../../tags/hp.html" style="font-size: 20pt">HP</a>&nbsp;&nbsp;
      <a href="../../../tags/libattachsql.html" style="font-size: 20pt">libAttachSQL</a>&nbsp;&nbsp;
      <a href="../../../tags/linuxjedi.html" style="font-size: 8pt">LinuxJedi</a>&nbsp;&nbsp;
      <a href="../../../tags/mysql.html" style="font-size: 20pt">MySQL</a>
</div></section>
     <hr /></aside></div> <!-- #main --></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo"><footer class="wrapper">&copy; Copyright 2014, Andrew (LinuxJedi) Hutchings. <br />The LinuxJedi logo and the content of this blog is licensed under a <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_GB">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.<br />Powered by <a href="http://www.tinkerer.me/">Tinkerer</a> and <a href="http://sphinx.pocoo.org/">Sphinx</a>.</footer></div> <!-- footer-container -->

      </div> <!--! end of #container --><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->
    </body>
</html>