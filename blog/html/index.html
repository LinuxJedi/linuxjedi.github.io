

<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="LinuxJedi's Technical Blog">
        <meta name="viewport" content="width=device-width">
        <title>Home &mdash; LinuxJedi&#39;s /dev/null</title>
            <link rel="stylesheet" href="_static/normalize.css" type="text/css">
            <link rel="stylesheet" href="_static/sphinx.css" type="text/css">
            <link rel="stylesheet" href="_static/main.css" type="text/css">
            <link rel="stylesheet" href="_static/minimal5.css" type="text/css">
            <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="_static/font-awesome.min.css" type="text/css">
        <link rel="shortcut icon" href="_static/favicon.ico" /><!-- Load modernizr and JQuery -->
        <script src="_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="_static/plugins.js"></script>
        <script src="_static/main.js"></script>
        <link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.4.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="_static/underscore.js"></script><script type="text/javascript" src="_static/doctools.js"></script><script type="text/javascript" src="_static/disqus.js"></script><script type="text/javascript" src="_static/google_analytics.js"></script></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container">
  <nav role="navigation">
    <ul><li class="quicklink"><div class="rss">
        <a href="rss.html" title="Subscribe via RSS"><span class="fa fa-lg fa-rss"></span></a>
    </div></li><li class="main-nav">
          <a href="#">Home</a>
        </li>
      <li class="main-nav">
          <a href="pages/about_me.html">About LinuxJedi</a>
        </li>
      </ul>
  </nav>
  <header role="banner">
    <hgroup>
    <h1><a href="#"><img src="_static/LinuxJedi_head.png" alt="LinuxJedi&#39;s /dev/null" /></a></h1><h2>The /dev/null ramblings of a Linux Jedi</h2></hgroup>
  </header><div class="main-container" role="main"><div class="main wrapper clearfix"><article role="article"><div class="timestamp postmeta">
            <span>September 23, 2014</span>
        </div>
        <h1><a href="2014/09/23/libattachsql_query_example.html">libAttachSQL Query Example</a></h1>
<p>I was asked some questions on IRC last night about how the query example in libAttachSQL’s code base works.  For those who missed previous posts, <a class="reference external" href="http://libattachsql.org">libAttachSQL</a> is a lightweight, non-blocking, Apache 2.0 licensed C connector for MySQL servers which I am developing for HP’s Advanced Technology Group.</p>
<p>In this blog post I’m going to break down <a class="reference external" href="https://github.com/libattachsql/libattachsql/blob/master/examples/basic_query.c">a basic query example</a> and explain what is happening at each step. It is possible that this syntax may change slightly by the time we hit GA but it will be similar to this.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="cp">#include &lt;libattachsql-1.0/attachsql.h&gt;</span>
<span class="cp">#include &lt;stddef.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
</pre></div>
</div>
<p>Only one include is needed for the library itself, <span class="docutils literal"><span class="pre">libattachsql-1.0/attachsql.h</span></span>. The others are used for other functions in the code.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="kt">attachsql_connect_t</span> <span class="o">*</span><span class="n">con</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">attachsql_error_st</span> <span class="o">*</span><span class="n">error</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">query</span><span class="o">=</span> <span class="s">"SELECT * FROM t1 WHERE name='fred'"</span><span class="p">;</span>
  <span class="kt">attachsql_return_t</span> <span class="n">ret</span><span class="o">=</span> <span class="n">ATTACHSQL_RETURN_NONE</span><span class="p">;</span>
  <span class="n">attachsql_query_row_st</span> <span class="o">*</span><span class="n">row</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">columns</span><span class="p">,</span> <span class="n">current_column</span><span class="p">;</span>
</pre></div>
</div>
<p>Here we have setup a few required variables:</p>
<ul class="simple">
<li><span class="docutils literal"><span class="pre">con</span></span> is the connection object used throughout this example</li>
<li><span class="docutils literal"><span class="pre">error</span></span> is an error struct which is set when an error occurs</li>
<li><span class="docutils literal"><span class="pre">query</span></span> this is a constant containing the query we wish to execute</li>
<li><span class="docutils literal"><span class="pre">ret</span></span> is where the return code is store for the network functions</li>
<li><span class="docutils literal"><span class="pre">row</span></span> holds the row results</li>
<li><span class="docutils literal"><span class="pre">columns</span></span> and <span class="docutils literal"><span class="pre">current_column</span></span> are used for iterating though the result</li>
</ul>
<div class="highlight-cpp"><div class="highlight"><pre><span class="n">con</span><span class="o">=</span> <span class="n">attachsql_connect_create</span><span class="p">(</span><span class="s">"localhost"</span><span class="p">,</span> <span class="mi">3306</span><span class="p">,</span> <span class="s">"test"</span><span class="p">,</span> <span class="s">"test"</span><span class="p">,</span> <span class="s">"testdb"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></div>
</div>
<p>This function creates the connection object.  A connection is not actually made at this point, we are just setting things up.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="n">error</span><span class="o">=</span> <span class="n">attachsql_query</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">query</span><span class="p">),</span> <span class="n">query</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></div>
</div>
<p>This starts the process of connecting to the MySQL server and sending the query.  The last two parameters are for a way to escape data at the client end in a similar way to prepared statements.  I’ll cover this in another blog post.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="k">while</span> <span class="p">((</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">ATTACHSQL_RETURN_EOF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
<span class="p">{</span>
  <span class="n">ret</span><span class="o">=</span> <span class="n">attachsql_connect_poll</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
</pre></div>
</div>
<p>This is where the magic happens.  Whilst we haven’t hit a query EOF or an error we are repeatedly polling the connection to see if we have have a row ready in the network buffer.</p>
<p>Not only this but a non-blocking DNS lookup, connection and handshake is made here, so it is likely poll will be called several times.  There is an API call to make the connection explicit rather than implicit on the first query and it will need to call <span class="docutils literal"><span class="pre">attachsql_connect_poll()</span></span> in the same way.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">ATTACHSQL_RETURN_ROW_READY</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">continue</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If we don’t have a row yet continue polling until we do.  In a real-world application you can have other tasks on your main thread going on here and/or poll many connections on a single thread.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="n">row</span><span class="o">=</span> <span class="n">attachsql_query_row_get</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
</pre></div>
</div>
<p>Process the row and return an array of pointers to the network read buffer for parts of the row.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="n">columns</span><span class="o">=</span> <span class="n">attachsql_query_column_count</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>

<span class="k">for</span> <span class="p">(</span><span class="n">current_column</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">current_column</span> <span class="o">&lt;</span> <span class="n">columns</span><span class="p">;</span> <span class="n">current_column</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%.*s "</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">row</span><span class="p">[</span><span class="n">current_column</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">current_column</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
</pre></div>
</div>
<p>Iterate through the columns in the row and print out the result.  Technically we only need to call <span class="docutils literal"><span class="pre">attachsql_query_column_count()</span></span> once when the first row is ready in the buffer.</p>
<div class="highlight-cpp"><div class="highlight"><pre>  <span class="n">attachsql_query_row_next</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This tells the library that we are done with this row and are ready to retrieve the next, which brings us back to polling.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Error occurred: %s"</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">);</span>
  <span class="n">attachsql_error_free</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If we have broken out of the loop due to an error, print that out and free the error object.</p>
<div class="highlight-cpp"><div class="highlight"><pre>  <span class="n">attachsql_query_close</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
  <span class="n">attachsql_connect_destroy</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Close the query and destroy the connection.  All done!</p>

        <div class="postmeta">
        <div class="author">
            <span>Posted by Andrew (LinuxJedi) Hutchings</span>
        </div>
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/mysql.html">MySQL</a>, <a href="categories/libattachsql.html">libAttachSQL</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/mysql.html">MySQL</a>, <a href="tags/libattachsql.html">libAttachSQL</a>, <a href="tags/hp.html">HP</a>, <a href="tags/advanced_technology_group.html">Advanced Technology Group</a></span>
        </div>
        <div class="comments">
            <a href="http://linuxjedi.co.uk/blog/html/2014/09/23/libattachsql_query_example.html#disqus_thread" data-disqus-identifier="2014/09/23/libattachsql_query_example">Leave a comment</a>
        </div></div><div class="separator post_separator"></div><div class="timestamp postmeta">
            <span>September 23, 2014</span>
        </div>
        <h1><a href="2014/09/23/new_blog.html">New Blog!</a></h1>
<p>Blogger is a great blogging platform.  Unfortunately it is really difficut to create content that has marked-up code in it.  Which as a developer is a requirement.  Therefore LinuxJedi’s /dev/null has now moved to this GitHub pages site using <a class="reference external" href="http://tinkerer.me">Tinkerer</a> to build it.</p>
<p>The old site and content can still be accessed at <a class="reference external" href="http://thelinuxjedi.blogspot.com">http://thelinuxjedi.blogspot.com/</a>.</p>

        <div class="postmeta">
        <div class="author">
            <span>Posted by Andrew (LinuxJedi) Hutchings</span>
        </div>
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/general.html">General</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/linuxjedi.html">LinuxJedi</a></span>
        </div>
        <div class="comments">
            <a href="http://linuxjedi.co.uk/blog/html/2014/09/23/new_blog.html#disqus_thread" data-disqus-identifier="2014/09/23/new_blog">Leave a comment</a>
        </div></div><div class="archive_link">
        <a href="archive.html"> &mdash; Blog Archive &mdash; </a>
    </div></article><aside class="sidebar"><section><div class="widget" id="conference" role="conference">
<h1>Percona Live London</h1>
<a href="http://www.percona.com/live/london-2014/"><img width="123" height="123" title="Percona Live London, November 3-4, 2014" alt="Percona Live London, November 3-4, 2014" src="http://s0.percona.com/percona-live/pluk14/123x123_UKSpeaking_14.png" /></a>
</div></section>
     <hr /><section><div class="widget" id="book" role="book">
<h1>MySQL 5.1 Plugins Development</h1>
<a href="https://www.packtpub.com/mysql-5-1-plugins-development/book"><img border="0" style="float:left" src="_static/0608OS_MockupCover_sm.png" />
MySQL 5.1 Plugins Development</a> by Andrew Hutchings and Sergei Golubchik is now available from Packt Publishing.
<br style="clear:left;" />
</div></section>
     <hr /><section><div class="widget">
    <h1>Recent Posts</h1>
    <ul><li>
            <a href="2014/09/23/libattachsql_query_example.html">libAttachSQL Query Example</a>
        </li><li>
            <a href="2014/09/23/new_blog.html">New Blog!</a>
        </li></ul>
</div>
</section>
     <hr /><section><div class="widget" id="searchbox" role="search">
    <h1>Search</h1>
    <form action="search.html" method="get">
        <input type="text" name="q" />
        <button type="submit"><span class="fa fa-search"></span></button>
    </form>
</div></section>
     <hr /><section><div class="widget">
    <h1>Tags Cloud</h1>
      <a href="tags/advanced_technology_group.html" style="font-size: 8pt">Advanced Technology Group</a>&nbsp;&nbsp;
      <a href="tags/hp.html" style="font-size: 8pt">HP</a>&nbsp;&nbsp;
      <a href="tags/libattachsql.html" style="font-size: 8pt">libAttachSQL</a>&nbsp;&nbsp;
      <a href="tags/linuxjedi.html" style="font-size: 8pt">LinuxJedi</a>&nbsp;&nbsp;
      <a href="tags/mysql.html" style="font-size: 8pt">MySQL</a>
</div></section>
     <hr /></aside></div> <!-- #main --></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo"><footer class="wrapper">&copy; Copyright 2014, Andrew (LinuxJedi) Hutchings. <br />The LinuxJedi logo and the content of this blog is licensed under a <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_GB">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.<br />Powered by <a href="http://www.tinkerer.me/">Tinkerer</a> and <a href="http://sphinx.pocoo.org/">Sphinx</a>.</footer></div> <!-- footer-container -->

      </div> <!--! end of #container --><script type="text/javascript">    var disqus_shortname = "linuxjedi";    disqus_count();</script><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->
    </body>
</html>